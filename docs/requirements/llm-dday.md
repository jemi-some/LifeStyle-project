# LLM D-Day 설정 기능 사양

## 목적과 범위
- 사용자가 자연어로 "<영화명> 개봉일 디데이 설정" 요청 시, LLM과 영화 검색 툴을 이용해 D-Day를 계산하고 저장하는 흐름 정의.
- FastAPI 백엔드에서 엔드포인트로 노출되며, D-Day 데이터는 추후 UI/알림 모듈에서 소비.
- 서비스의 핵심 목적은 팬들이 같은 개봉일을 함께 기다리며 팬심을 나누는 것.
- 계산된 D-Day는 프로젝트/영화 단위로 단일 레코드로 관리되어 모든 사용자가 동일한 값을 조회.

## 사용자 입력 패턴
- 기본 패턴: `"프로젝트 헤일메일 개봉일 디데이 설정"`처럼 `<이름> 개봉일 디데이 설정`.
- 변형 허용: "개봉일 디데이 맞춰줘", "디데이 다시 잡아줘" 등 유사 표현 포함.
- 사용자가 직접 개봉일(`YYYY-MM-DD`)을 제공할 수도 있으므로 날짜 추출 로직 포함.
- 직접 입력한 개봉일은 영화 검색 툴에서 반환한 날짜와 대조해 검증하고, 차이가 있으면 사용자에게 확인 요청.
- 다의어/복수 영화명 입력 시 LLM이 추가 정보를 질문하도록 명시.

## 의도 및 엔터티 추출
- LLM 프롬프트에서 행동(intent) = "디데이 설정"인지 판단 후, `project_name`, `movie_title`, `explicit_release_date` 엔터티 추출.
- 명확한 영화명이 없으면 follow-up 질문을 하도록 가드레일 안내.

## 영화 검색 툴 요구사항
- 툴 호출 파라미터: `title`(필수), `year`(선택), `language`(선택).
- 응답 필드 설명:
  - `title`: LLM과 사용자에게 그대로 노출될 정식 영화 제목.
  - `release_date`: ISO8601 `YYYY-MM-DD` 포맷의 개봉일, D-Day 계산의 핵심 입력.
  - `overview`: 줄거리나 간단 설명으로 사용자 응답 구성 시 맥락 제공.
  - `external_id`: TMDb, KOBIS 등 원본 API의 고유 식별자. 추후 상세 조회나 캐시 키로 사용.
  - `country`: 개봉 국가 코드/명칭. 동일 제목 다수일 때 필터링하거나 사용자 확인용으로 사용.
- 동일 제목 다수 시 미래 개봉일이 존재하면 가장 가까운 미래 개봉일을 우선 사용하고, 모두 과거라면 재개봉 일정이 있는지 재조회한 뒤 없으면 D-Day 생성 없이 사용자에게 안내.
- 실패 시 오류 코드/메시지를 반환해 LLM이 사용자에게 재요청 가능.

## D-Day 계산 규칙
- 기준일: 서버 로컬(KST) 또는 UTC 기반 후 변환, 사양에 명시.
- 계산 공식: `days = (release_date - today).days`; `days > 0` → `D-{days}`, `days == 0` → `D-DAY`, `days < 0` → `D+{abs(days)}`.
- 시간이 포함된 날짜는 ISO8601로 파싱 후 날짜 단위 비교.
- 서비스 성격상 "개봉 전" 안내가 핵심이므로 `days > 0`인 미래 개봉일을 우선 계산하고, 모든 개봉일이 과거고 재개봉 일정도 없으면 D-Day를 생성하지 않고 상황을 설명.

## 데이터 저장 및 모델 요구
- `projects` 테이블 예시:
  - `id`: 내부 식별자(UUID/INT)로 API 응답과 관계형 조인에 사용.
  - `name`: 사용자에게 보여줄 프로젝트명/별칭. 제목이 길 경우 커스텀 네이밍 저장.
  - `movie_title`: 영화 검색 툴에서 얻은 정식 제목. `name`과 다를 수 있음.
  - `distributor`: 배급사 이름. 여러 개일 때 콤마로 저장.
  - `release_date`: D-Day 계산에 사용되는 ISO 날짜(확정/예정 모두 포함).
  - `director`: 감독 이름(복수일 경우 콤마 구분).
  - `cast`: 주요 출연진 리스트. 정해진 인원(예: Top 5) 저장.
  - `genre`: 대표 장르 문자열. 복합 장르는 슬래시/콤마 사용.
  - `dday_label`: 계산된 `D-10`, `D-DAY` 등 문자열 캐시.
  - `last_updated`: 레코드 갱신 시각으로 캐시 무효화, 변경 이력 판단에 활용.
- 동일 프로젝트 재요청 시 기존 레코드를 먼저 조회해 즉시 반환하고, 없을 때만 영화 검색 및 신규 생성.
- D-Day는 전 사용자 공유 데이터이므로 `name` 또는 `movie_title`에 유니크 인덱스를 두고 중복 생성을 방지.
- 필요 시 변경 이력을 위한 별도 로그 테이블 고려.

## 오류 및 예외 처리
- 영화 검색 실패: "영화를 찾지 못했습니다. 제목을 다시 알려주세요." 메시지.
- 날짜 포맷 오류: 정규식 검증 후 재입력을 요청.
- 외부 API 장애: 재시도 정책(예: 2회) 후 graceful fallback.

## 응답 형식
- 성공: 영화 요약, 개봉일, 계산된 D-Day를 포함하고 저장 성공을 암시(별도 확인 단계 없이 자동 저장).
- 실패: 문제 원인과 다음 행동 지침 제공.

## 테스트 및 검증 지침
- Mock 영화 API로 e2e 흐름 테스트.
- 단위 테스트: LLM 의도 분류, 툴 호출 스키마, D-Day 계산 함수.
- 커버리지 목표 ≥80%.
